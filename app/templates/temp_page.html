{% extends 'base.html' %}
{% block content %}
<h1 class="page-info">
    <p>{{ selected_location }}({{ purpose }})의 현재 온・습도</p>
    <select id="location-select" class="select-bar">
        {% for location in location_list %}
        <option value="{{ location.location }}" {% if location.location==selected_location %}selected{% endif %}>
            {{ location.location }}
        </option>
        {% endfor %}
    </select>
    {% if g.admin %}
    <button type="button" class="temp-class-edit">교실 정보 수정하기</button>
    {% endif %}
</h1>
<div class="temp-page">
    <div class="real-time-data">
        <div class="temp">
            <p class="numerical-data" id="current-temp">{{ temp }}℃</p>
            <p>온도</p>
        </div>
        <div class="vertical"></div>
        <div class="humi">
            <p class="numerical-data" id="current-humi">{{ humi }}%</p>
            <p>습도</p>
        </div>
    </div>
    <p id="recommend-temp">오늘은 {{ current_date }}입니다. 추천 온도는 {{ recommend_temp }}도 입니다.</p>
    <div class="month-datas">
        <h2>지난 1년간 평균 온・습도</h2>
        <div class="month-data-box" id="month-data-container">
            {% for i in range(1,13) %}
            <div class="month-box">
                {% set month_data = month_data_dict.get(i) %}
                {% if month_data %}
                <p>평균 온도 : {{ month_data.avg_temp | round(1) }}℃</p>
                <p>평균 습도 : {{ month_data.avg_humi | round(1) }}%</p>
                {% else %}
                <p>측정 데이터 없음</p>
                <p>측정 데이터 없음</p>
                {% endif %}
                <p style="font-weight: bold;">{{ i }}월</p>
            </div>
            {% endfor %}
        </div>
    </div>
    <p>※ 모든 정보는 실시간으로 갱신됩니다.</p>
</div>

<div class="edit-modal-backdrop">
    <div id="temp-edit-modal-content">
        <span class="close-modal-btn">&times;</span>
        <div id="modal-tabs">
            <button type="button" class="modal-tab-btn active" data-tab="add">추가</button>
            <button type="button" class="modal-tab-btn" data-tab="edit">수정</button>
            <button type="button" class="modal-tab-btn" data-tab="delete">삭제</button>
        </div>

        <input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}">

        <div class="modal-content-area">

            <!-- 추가 탭 폼 -->
            <div id="tab-add" class="modal-tab active">
                <form id="form-add-location">
                    <h2 class="modal-title">교실 추가</h2>
                    <div class="form-group">
                        <label for="add-location">교실 선택</label>
                        <select id="add-location-select" class="form-control">
                            <option value="">-- 교실 선택 --</option>
                            {% for loc in unassigned_locations %}
                            <option value="{{ loc.location }}">{{ loc.location }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="add-purpose">교실 목적 (예 : 1학년 교실)</label>
                        <input type="text" id="add-purpose" class="form-control" placeholder="목적 입력 (없으면 비워두기)">
                    </div>
                    <div id="add-message" class="modal-message"></div>
                    <div class="form-btn">
                        <button type="submit" class="save-btn">추가하기</button>
                    </div>
                </form>
            </div>

            <!-- 수정 탭 폼 -->
            <div id="tab-edit" class="modal-tab">
                <form id="form-edit-location">
                    <h2 class="modal-title">교실 수정</h2>
                    <div class="form-group">
                        <label for="edit-location-select">교실 선택</label>
                        <select id="edit-location-select" class="form-control">
                            <option value="">-- 수정할 교실 선택 --</option>
                            {% for loc in location_list %}
                            <option value="{{ loc.location }}">{{ loc.location }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-purpose">교실 목적 (예 : 1학년 교실)</label>
                        <input type="text" id="edit-purpose" class="form-control" placeholder="목적 입력">
                    </div>
                    <div id="edit-message" class="modal-message"></div>
                    <div class="form-btn">
                        <button type="submit" class="save-btn">수정하기</button>
                    </div>
                </form>
            </div>

            <!-- 삭제 탭 폼 -->
            <div id="tab-delete" class="modal-tab">
                <form id="form-delete-location">
                    <h2 class="modal-title">교실 삭제</h2>
                    <div class="form-group">
                        <label for="delete-location-select">교실 선택</label>
                        <select id="delete-location-select" class="form-control">
                            <option value="">-- 삭제할 교실 선택 --</option>
                            {% for loc in location_list %}
                            <option value="{{ loc.location }}">{{ loc.location }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="delete-purpose-readonly">교실 목적</label>
                        <input type="text" id="delete-purpose-readonly" class="form-control" readonly>
                    </div>
                    <div id="delete-message" class="modal-message"></div>
                    <div class="form-btn">
                        <button type="submit" class="delete-btn">삭제하기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}

<script>
    const streamUrl = "{{ url_for('temp.stream', location=selected_location) }}";

    const monthDataUrl = "{{ url_for('temp.month_data', location=selected_location )}}";

    const locationApiBaseUrl = "{{ url_for('temp.manage_location', location_name='LOCATION_NAME_PLACEHOLDER') }}";

    document.getElementById('location-select').addEventListener('change', function (e) {
        const newLocation = e.target.value;
        const currentUrl = new URL(window.location.href);

        currentUrl.searchParams.set('location', newLocation);
        window.location.href = currentUrl.href;
    })
</script>

<script src="{{ url_for('static', filename='js/temp.js') }}"></script>
{% endblock %}